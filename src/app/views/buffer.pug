extends template

block body
  a#api-link(href= rootPath + "api/" + view)
  table#buffer.mdl-data-table(style='width: 100%;', cellspacing="0")
    thead
      tr
        each column in schema
          th= column.data
  script.
    var refresh_time = #{refresh_time}
    var schema = !{JSON.stringify(schema)}
  script
    :coffee-script
      view = $("#api-link").attr("href")
      table = null
      setStatus = (request) ->
        reload_callback = () ->
          "ok"
        table.ajax.reload( reload_callback , false)
      decode = (response) ->
        setStatus request for request in response
      $ ->
        table = $('#buffer').DataTable({
          paging: true,
          retrieve: true,
          searching: true,
          ajax: {url: view, dataSrc: ''}, 
          columns: schema,
          "columnDefs": [
            {
              "render": (data, type, row ) ->
                if (data && data.length)
                  return data.length
                return 0;
              ,
              "targets": [8, 6]            
            }
          ]
        });

        auto_refresh = $("#auto-refresh").is(':checked')
        $('#buffer tbody').on 'click', 'tr', ->
          data = table.row( this ).data()
          window.open("/request/" + data.requestID, "_blank")

        $('#auto-refresh').change -> 
          auto_refresh = $("#auto-refresh").is(':checked')
          if auto_refresh
            refresh()

        callback = (response) -> 
          decode(response)
          if auto_refresh
            setTimeout(refresh, refresh_time)

        refresh = () -> 
            $.get view, callback
        if auto_refresh
          refresh()
