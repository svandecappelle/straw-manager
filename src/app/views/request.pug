extends template

block body
  if !request
    .page-header
      h1 Request is invalid
  else
    .page-header.request-view(id="request-" + request.requestID, data-id=request.requestID)
      h1 Request: #{request.requestID}
        span.badge #{request.status}
    .col-xs-12.col-md-12.request
      a(href=request.url)= request.url
      if request.stores
        .row
          .col-xs-6.col-md-4 Magasins Ã  aspirer
            .badge= request.stores.length
          .col-xs-6.col-md-4= request.stores
      if request.error
        .col-xs-12.col-md-12
          .alert.alert-danger Error caught
            pre.well
              p= JSON.stringify(request.error, null, 4)
      ul.list-group#datas
        each val, index in request.data
          li.list-group-item.row
            .col-xs-6.col-md-4= index
            .col-xs-6.col-md-4= val
      if request.stores_detail
        ul.list-group#stores-datas
          li.list-group-item.row.active
            .col-xs-6.col-md-4.text-center Magasin
            .col-xs-6.col-md-4.text-center Prix
            .col-xs-6.col-md-4.text-center Promo
          
          each store_detail, storeid in request.stores_detail
            if store_detail
              li.list-group-item.row
                .col-xs-6.col-md-4= storeid
                .col-xs-6.col-md-4= store_detail.prix
                .col-xs-6.col-md-4= store_detail.promo
            else
              .message= store_detail
      else
        .message no detail mag
    script.
      var refresh_time = #{refresh_time}
    script
      :coffee-script
        rootPath = $("#root-collect-online").attr("href")
        decode = (request) ->
          $("#request-" + request.requestID + " span.badge").text(request.status)
          $("#datas").empty()
          if request.error
            if ($(".alert.alert-danger").length == 0)
              $('.request').append($('<div>', {
                "class": "col-xs-12 col-md-12"
              }).append($("<div>", {
                "class": "alert alert-danger"
              }).text("Error caught").append($("<pre>", {
                "class": "well"
              }))))
            $(".request .alert.alert-danger .well").text(JSON.stringify request.error, null, 4)
          for data, value of request.data
            obj = $("<li>", {
              class: "list-group-item row" 
            })
            obj.append($("<div>", {
              class: "col-xs-6 col-md-4"
            }).text(data))
            obj.append($("<div>", {
              class: "col-xs-6 col-md-4"
            }).text(value))
            $("#datas").append(obj)
            
          if (request.status != "pending")
            $("#auto-refresh").removeClass("active")
        $ ->
          $('#auto-refresh').click ->
            $(this).toggleClass("active")
            refresh()
          callback = (response) -> 
            decode(response)
            auto_refresh = $("#auto-refresh").hasClass("active")
            if auto_refresh
              setTimeout(refresh, refresh_time)
          refresh = () -> 
            $.get rootPath + "api/request/" + $(".request-view").data('id'), callback
          refresh()
